name: Security Regression

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '17 3 * * *'

concurrency:
  group: security-regression-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        working-directory: frontend-admin
        run: npx playwright install --with-deps chromium

      - name: Prepare CI env file
        run: |
          cat > .env <<'EOF'
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_NAME=calabasas_db
          JWT_SECRET=ci-secret-change-me
          JWT_EXPIRES_IN=12h
          REFRESH_TOKEN_EXPIRES_IN=7d
          MAX_ACTIVE_REFRESH_SESSIONS=5
          REFRESH_REVOKED_RETENTION_DAYS=30
          SESSION_AUDIT_EXPORT_MAX_LIMIT=20000
          SESSION_AUDIT_RETENTION_DAYS=90
          SESSION_AUDIT_PRUNE_INTERVAL_MINUTES=60
          SECURITY_METRICS_WINDOW_HOURS=24
          SECURITY_METRICS_TOP_N=10
          SECURITY_METRICS_SNAPSHOT_INTERVAL_MINUTES=15
          SECURITY_METRICS_SNAPSHOT_RETENTION_DAYS=30
          SECURITY_METRICS_HISTORY_DEFAULT_POINTS=96
          CORS_ORIGIN=*
          EOF

      - name: Build and start stack
        run: docker compose up -d --build

      - name: Wait for health
        run: |
          timeout 180 bash -c 'until [ "$(docker inspect -f "{{.State.Health.Status}}" calabasas-proxy 2>/dev/null)" = "healthy" ]; do sleep 3; done'
          docker compose ps

      - name: Bootstrap admin user
        run: |
          docker compose exec -T backend-api sh -lc \
            'ADMIN_EMAIL=security.test@local ADMIN_PASSWORD=ChangeMe123! ADMIN_NAME="Security Test" ADMIN_ROLE=ADMIN npm run bootstrap:admin'

      - name: Regression suite
        run: ./scripts/ops.sh regression

      - name: Backend build check
        run: npm run --workspace backend-api build

      - name: Frontend admin build check
        run: npm run --workspace frontend-admin build

      - name: Capture compose logs on failure
        if: failure()
        run: |
          mkdir -p artifacts
          docker compose logs --no-color --tail=400 > artifacts/compose-logs.txt

      - name: Notify webhook on failure
        if: failure()
        env:
          ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
          ALERT_CHANNEL: ${{ secrets.ALERT_CHANNEL }}
        run: |
          ./scripts/ci-webhook-alert.sh "[CI][security-regression][FAIL] repo=${{ github.repository }} ref=${{ github.ref_name }} run=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            frontend-admin/playwright-report/**
            frontend-admin/test-results/**
          if-no-files-found: ignore

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            frontend-admin/coverage/**
          if-no-files-found: ignore

      - name: Upload compose logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compose-logs
          path: artifacts/compose-logs.txt
          if-no-files-found: ignore

      - name: Teardown
        if: always()
        run: docker compose down -v
